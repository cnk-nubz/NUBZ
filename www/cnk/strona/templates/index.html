<!DOCTYPE html>
{% load compress %}
{% load staticfiles %}
{% load jsvar %}
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="{% static "favicon.ico" %}">

  <title>Tajny Projekt NUBZ</title>

  <script src="{% static "js/jquery.min.js" %}"></script>
  <script src="{% static "js/bootstrap.min.js" %}"></script>
  <script src="{% static "js/bootstrap-dialog.js" %}"></script>
  <script src="{% static "js/ie10-viewport-bug-workaround.js" %}"></script>

  <!-- LEAFLET -->
  <script src="{% static "js/leaflet-src.js" %}"></script>
  <script src="{% static "js/easy-button.js" %}"></script>
  <script src="{% static "js/Label.js" %}"></script>
  <script src="{% static "js/BaseMarkerMethods.js" %}"></script>
  <script src="{% static "js/Marker.Label.js" %}"></script>
  <script src="{% static "js/Path.Label.js" %}"></script>
  <script src="{% static "js/Map.Label.js" %}"></script>
  <script src="{% static "js/FeatureGroup.Label.js" %}"></script>

  <!-- CSS -->
  <link href="{% static "css/bootstrap.min.css" %}" rel="stylesheet" />
  <link href="{% static "css/base.css" %}" rel="stylesheet" />
  <link href="{% static "css/leaflet.css" %}" rel="stylesheet" />
  <link href="{% static "css/easy-button.css" %}" rel="stylesheet" />
  <link href="{% static "css/leaflet.label.css" %}" rel="stylesheet" />
  <link href="{% static "css/font-awesome.min.css" %}" rel="stylesheet" />
  <link href="{% static "css/bootstrap-dialog.css" %}" rel="stylesheet" />
</head>
<body>
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li id="navJustMap" class="active">
            <a style="cursor: pointer;">Podgląd mapy</a>
          </li>
          <li id="navEditMap">
            <a style="cursor: pointer;">Edycja mapy</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div>
    <form id="imageUploadForm" class="form-inline" style="display: none;">
      {% csrf_token %}
      <div id="formSpacer">
        <div class="form-group">
          <input id="uploadImage" class="form-control" type="file" name="image" required="true" accept="image/*" />
        </div>
        <input id="imageFormSubmit" class="btn btn-default btn-xs" type="submit" value="Prześlij" />
        <input id="hiddenFloorLevel" type="hidden" name="floor" value="{{activeFloor}}" />
      </div>
    </form>
  </div>

  <div id="map" class="without-form"></div>
  <div id="control-panel" class="without-form detached-control-panel">&nbsp;</div>

  {% compress js %}
  <script src="{% static "coffee/frame.class.coffee"%}" type="text/coffeescript"></script>
  {% endcompress %}

  {% compress js %}
  <script src="{% static "coffee/exhibit.class.coffee"%}" type="text/coffeescript"></script>
  {% endcompress %}

  {% compress js %}
  <script src="{% static "coffee/navbar.class.coffee"%}" type="text/coffeescript"></script>
  {% endcompress %}

  {% compress js %}
  <script src="{% static "coffee/canvas.class.coffee"%}" type="text/coffeescript"></script>
  {% endcompress %}

  {% compress js %}
  <script type="text/coffeescript">
    errorData = [
    	{"message": "Mapa piętra została pomyślnie zmieniona", "type": BootstrapDialog.TYPE_SUCCESS, "title": "Sukces"}
    	{"message": "Niepoprawny format. Obsługiwane rozszerzenia: .png .jpg .gif .bmp", "type": BootstrapDialog.TYPE_INFO, "title": "Zły format"}
    	{"message": "Wystąpił wewnętrzny błąd serwera - spróbuj ponownie za chwilę", "type": BootstrapDialog.TYPE_DANGER, "title": "Błąd serwera"}
    	{"message": "form error - not POST method", "type": BootstrapDialog.TYPE_DANGER, "title": "not POST method"}
    ]
    root = exports ? this
    #DJANGO VARIABLES
    urlFloor = [
      "{{urlFloor0|escape|safe}}"
      "{{urlFloor1|escape|safe}}"
    ]
    activeFloor = +"{{acitveFloor}}"
    exhibits = jQuery.map({{exhibits | jsvar}}, (val) -> [val])
    floorTilesInfo = jQuery.map({{floorTilesInfo | jsvar}}, (val) -> [val])
    (floorTilesInfo[i] = jQuery.map(floorTilesInfo[i], (val) -> [val])) for i in [0..1]
    visibleExhibits = [
      (e for e in exhibits when e.frame? and e.frame.mapLevel is 0),
      (e for e in exhibits when e.frame? and e.frame.mapLevel is 1)
    ]

    #INIT PAGE WHEN DOM IS READY
    jQuery(document).ready( ->
      navbar = new root.Navbar()
      canvas = new root.Canvas(1, 3, activeFloor)
      #boundaries will be set according to highest zoom
      mapWidth = (floorTilesInfo[i][-1..][0].scaledWidth for i in [0..1])
      mapHeight = (floorTilesInfo[i][-1..][0].scaledHeight for i in [0..1])
      for i in [0..1]
        canvas.addMapBounds(i, [0, mapHeight[i]], [mapWidth[i], 0])
        canvas.addFloorLayer(i, floorTilesInfo[i], urlFloor[i])
        canvas.addExhibits(i, visibleExhibits[i])

      canvas.setFloorLayer(activeFloor)(canvas._floorButton[activeFloor])

      #set handler for upload form
      jQuery("#imageUploadForm").submit((e) ->
        jQuery "#imageFormSubmit"
          .prop("disabled", true)

        jQuery.ajax(
          type: "POST"
          url: "/uploadImage/"
          data: new FormData(this)
          processData: false
          contentType: false

          success: (data) ->
            data.floorTilesInfo[data.floor] = jQuery.map(data.floorTilesInfo[data.floor], (val) -> [val])
            errorIdx = data.err - 1
            BootstrapDialog.show({
                  message: errorData[errorIdx].message
                  type: errorData[errorIdx].type
                  title: errorData[errorIdx].title
                  closeByBackdrop: false
                  buttons: [{
                      label: 'Zamknij',
                      action: (dialogRef) ->
                        dialogRef.close();
                  }]
            })
            if errorIdx is 0
              canvas.refreshMap(data.floor, data.floorTilesInfo[data.floor], urlFloor[data.floor]) 
            jQuery "#uploadImage" #reset input value
              .val ''
            jQuery "#imageFormSubmit"
              .prop("disabled", false)
            return
        )
        e.preventDefault()
        return
      )
      navbar._init canvas
    )
  </script>
  {% endcompress %}
</body>
</html>
